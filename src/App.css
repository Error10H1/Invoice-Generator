import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Plus, 
  Trash2, 
  Save, 
  Printer, 
  Settings, 
  FileText, 
  Briefcase, 
  CreditCard, 
  Percent, 
  ChevronDown, 
  LayoutTemplate, 
  Package, 
  Image as ImageIcon, 
  Upload, 
  FolderOpen, 
  X, 
  ArrowRight, 
  Download, 
  Upload as UploadIcon, 
  RefreshCw, 
  CheckCircle, 
  Circle,
  Eye,
  EyeOff,
  FilePlus,
  Copy
} from 'lucide-react';

// --- Components ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, variant = "primary", className = "", icon: Icon, title, disabled }) => {
  const baseStyle = "flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed";
  const variants = {
    primary: "bg-blue-600 text-white hover:bg-blue-700 active:scale-95",
    secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200 active:scale-95",
    danger: "bg-red-50 text-red-600 hover:bg-red-100 active:scale-95",
    outline: "border border-slate-300 text-slate-600 hover:bg-slate-50",
    ghost: "bg-transparent text-slate-500 hover:bg-slate-100 hover:text-slate-700 p-2"
  };

  return (
    <button type="button" onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`} title={title}>
      {Icon && <Icon size={18} />}
      {children}
    </button>
  );
};

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in-95 duration-200 flex flex-col max-h-[90vh]">
        <div className="flex justify-between items-center p-4 border-b border-slate-100 shrink-0">
          <h3 className="text-lg font-bold text-slate-800">{title}</h3>
          <button type="button" onClick={onClose} className="text-slate-400 hover:text-slate-600">
            <X size={20} />
          </button>
        </div>
        <div className="p-6 overflow-y-auto">
          {children}
        </div>
        <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-end shrink-0">
          <Button onClick={onClose} variant="secondary">Close</Button>
        </div>
      </div>
    </div>
  );
};

// --- Initial Data / Utils ---

const generateId = () => Math.random().toString(36).substr(2, 9);

const CURRENCY_FORMAT = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
});

const DEFAULT_MARKUP_PROFILES = [
  { id: 'm1', name: 'Standard Margin', type: 'percent', value: 20 },
  { id: 'm2', name: 'Friends & Family', type: 'percent', value: 0 },
  { id: 'm3', name: 'Rush Job', type: 'percent', value: 50 },
  { id: 'm4', name: 'Fixed Service Fee', type: 'fixed', value: 150 },
];

const DEFAULT_DEPOSIT_PROFILES = [
  { id: 'd1', name: '50% Upfront', type: 'percent', value: 50 },
  { id: 'd2', name: 'Booking Fee ($500)', type: 'fixed', value: 500 },
  { id: 'd3', name: 'No Deposit / Net 30', type: 'percent', value: 0 },
];

const DEFAULT_MATERIALS = [
  { id: 'mat1', name: 'Web Design Consultation (Hour)', price: 150, image: null },
  { id: 'mat2', name: 'Hosting Setup', price: 75, image: null },
];

const DEFAULT_LOGO_PROFILES = [];

const DEFAULT_INVOICE_STATE = {
  // ID is generated on init to ensure key uniqueness if not loaded
  number: 'INV-001',
  name: '', 
  date: new Date().toISOString().split('T')[0],
  dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
  from: { name: 'Your Company', address: '123 Creative Way\nDesign City, ST 12345' },
  to: { name: 'Client Name', address: '456 Client Road\nBusiness Town, ST 67890' },
  items: [
    { id: 'init_item', description: 'Initial Consultation', quantity: 1, price: 150, image: null }
  ],
  notes: 'Thank you for your business. Please send payment within 14 days.',
  isPaid: false, // New state for payment status
  hideMarkup: false, // New state for hiding markup
};

// --- Main App ---

export default function App() {
  // --- Data Loading Hooks ---
  // Helper to safely load JSON from localStorage
  const usePersistentState = (key, defaultValue) => {
    const [state, setState] = useState(() => {
      try {
        const saved = localStorage.getItem(key);
        return saved ? JSON.parse(saved) : defaultValue;
      } catch(e) { 
        console.error(`Error loading ${key}`, e);
        return defaultValue; 
      }
    });

    useEffect(() => {
      try {
        localStorage.setItem(key, JSON.stringify(state));
      } catch (e) {
        console.error(`Error saving ${key}`, e);
      }
    }, [key, state]);

    return [state, setState];
  };

  // --- State ---

  // Invoice Data (Active Draft)
  const [invoice, setInvoice] = useState(() => {
    try {
      const saved = localStorage.getItem('proInvoice_currentDraft');
      // Merge defaults to ensure new fields (like isPaid, hideMarkup) exist in old saved data
      return saved ? { ...DEFAULT_INVOICE_STATE, ...JSON.parse(saved) } : { ...DEFAULT_INVOICE_STATE, id: generateId() };
    } catch(e) { 
      return { ...DEFAULT_INVOICE_STATE, id: generateId() }; 
    }
  });

  // Settings / Profiles (Using Custom Hook for Auto-Persistence)
  const [markupProfiles, setMarkupProfiles] = usePersistentState('proInvoice_markups', DEFAULT_MARKUP_PROFILES);
  const [depositProfiles, setDepositProfiles] = usePersistentState('proInvoice_deposits', DEFAULT_DEPOSIT_PROFILES);
  const [savedMaterials, setSavedMaterials] = usePersistentState('proInvoice_materials', DEFAULT_MATERIALS);
  const [logoProfiles, setLogoProfiles] = usePersistentState('proInvoice_logos', DEFAULT_LOGO_PROFILES);
  const [savedInvoices, setSavedInvoices] = usePersistentState('proInvoice_invoices', []);
  
  // Preferences (Persist selection state)
  const [preferences, setPreferences] = usePersistentState('proInvoice_prefs', {
    selectedMarkupId: 'm1',
    selectedDepositId: 'd1',
    selectedLogoId: '',
    taxRate: 8.25
  });

  // Helper to update individual preferences
  const setPreference = (key, value) => {
    setPreferences(prev => ({ ...prev, [key]: value }));
  };

  // UI State
  const [showMaterialModal, setShowMaterialModal] = useState(false);
  const [showConfigModal, setShowConfigModal] = useState(false);
  const [showSaveModal, setShowSaveModal] = useState(false);
  const [showLoadModal, setShowLoadModal] = useState(false);
  const [isPrintMode, setIsPrintMode] = useState(false);
  const [isDownloading, setIsDownloading] = useState(false);

  // Temp State for modals
  const [tempMaterialImage, setTempMaterialImage] = useState(null);
  const [saveName, setSaveName] = useState('');
  const fileInputRef = useRef(null); // For Restore functionality

  // --- Effects ---
  
  // Auto-save Active Draft
  useEffect(() => {
    const timer = setTimeout(() => {
      localStorage.setItem('proInvoice_currentDraft', JSON.stringify(invoice));
    }, 500); // Debounce saves to 500ms
    return () => clearTimeout(timer);
  }, [invoice]);

  // --- Calculations ---

  const totals = useMemo(() => {
    const subtotal = invoice.items.reduce((acc, item) => acc + (item.quantity * item.price), 0);
    
    // Markup Calculation
    const activeMarkup = markupProfiles.find(p => p.id === preferences.selectedMarkupId);
    let markupAmount = 0;
    if (activeMarkup) {
      markupAmount = activeMarkup.type === 'percent' 
        ? subtotal * (activeMarkup.value / 100) 
        : activeMarkup.value;
    }

    const subtotalWithMarkup = subtotal + markupAmount;
    
    // Tax Calculation
    const taxAmount = subtotalWithMarkup * (preferences.taxRate / 100);
    const total = subtotalWithMarkup + taxAmount;

    // Deposit Calculation
    const activeDeposit = depositProfiles.find(p => p.id === preferences.selectedDepositId);
    let depositAmount = 0;
    if (activeDeposit) {
      depositAmount = activeDeposit.type === 'percent'
        ? total * (activeDeposit.value / 100)
        : activeDeposit.value;
    }

    // Logic for Paid vs Unpaid
    let balanceDue;
    if (invoice.isPaid) {
      balanceDue = 0;
    } else {
      // Guard against deposit > total
      if (depositAmount > total) depositAmount = total;
      balanceDue = total - depositAmount;
    }

    return {
      subtotal,
      markupAmount,
      markupName: activeMarkup?.name,
      subtotalWithMarkup,
      taxAmount,
      total,
      depositAmount,
      depositName: activeDeposit?.name,
      balanceDue
    };
  }, [invoice.items, invoice.isPaid, preferences, markupProfiles, depositProfiles]);

  const activeLogo = useMemo(() => logoProfiles.find(l => l.id === preferences.selectedLogoId), [logoProfiles, preferences.selectedLogoId]);

  // --- Handlers ---

  const handleNewInvoice = () => {
    if (confirm('Start a new invoice? This will clear the current form.')) {
      setInvoice({
        ...DEFAULT_INVOICE_STATE,
        id: generateId(),
        // Optional: Auto-increment or randomize number to suggest newness
        number: 'INV-' + Math.floor(1000 + Math.random() * 9000), 
        date: new Date().toISOString().split('T')[0],
        dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        items: [
          { id: generateId(), description: 'Initial Consultation', quantity: 1, price: 150, image: null }
        ]
      });
      setSaveName('');
    }
  };

  const handleAddItem = (item = null) => {
    if (item) {
      const newItem = { 
        ...item, 
        id: generateId(), 
        description: item.name || item.description || '', 
        quantity: 1 
      };
      setInvoice(prev => ({ ...prev, items: [...prev.items, newItem] }));
    } else {
      const newItem = { 
        id: generateId(), 
        description: '', 
        quantity: 1, 
        price: 0, 
        image: null 
      };
      setInvoice(prev => ({ ...prev, items: [...prev.items, newItem] }));
    }
  };

  const handleUpdateItem = (id, field, value) => {
    setInvoice(prev => ({
      ...prev,
      items: prev.items.map(item => item.id === id ? { ...item, [field]: value } : item)
    }));
  };

  const handleRemoveItem = (id) => {
    setInvoice(prev => ({
      ...prev,
      items: prev.items.filter(item => item.id !== id)
    }));
  };

  const handleItemImageUpload = (e, itemId) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        handleUpdateItem(itemId, 'image', reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handlePrint = () => {
    setIsPrintMode(true);
    setTimeout(() => {
      window.print();
      setIsPrintMode(false);
    }, 100);
  };

  // --- SELF-CONTAINED PDF LOADER & GENERATOR ---
  const handleDownloadPDF = async () => {
    setIsDownloading(true);
    
    // 1. Library Loader
    const loadPdfLibrary = () => {
      return new Promise((resolve, reject) => {
        if (window.html2pdf) {
          resolve(window.html2pdf);
          return;
        }
        const script = document.createElement('script');
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js";
        script.onload = () => resolve(window.html2pdf);
        script.onerror = () => reject(new Error("Failed to load PDF library"));
        document.body.appendChild(script);
      });
    };

    try {
      const html2pdf = await loadPdfLibrary();
      const originalElement = document.getElementById('invoice-content');

      // 2. Clone & Prepare for Capture
      const clone = originalElement.cloneNode(true);
      
      // Force desktop width on the clone & position it off-screen in a container
      const container = document.createElement('div');
      container.style.position = 'absolute';
      container.style.left = '-9999px';
      container.style.top = '0';
      container.style.width = '800px'; // Force Standard desktop/A4 width
      container.appendChild(clone);
      document.body.appendChild(container);

      // 3. Transform Inputs for "Print Look"
      const inputs = clone.querySelectorAll('textarea, input, select');
      inputs.forEach(input => {
        const textValue = input.value || '';
        const textNode = document.createElement('div');
        textNode.innerText = textValue;
        
        textNode.style.whiteSpace = 'pre-wrap';
        textNode.style.fontFamily = 'inherit';
        textNode.style.fontSize = 'inherit';
        textNode.style.fontWeight = 'inherit';
        textNode.style.color = '#334155'; // slate-700
        
        if (input.parentNode) {
            input.parentNode.replaceChild(textNode, input);
        }
      });

      const buttons = clone.querySelectorAll('button, .no-print');
      buttons.forEach(btn => btn.remove());
      
      // 4. Configure & Save with Page Breaks
      const opt = {
        margin: 0, // We have padding in CSS
        filename: `${invoice.number}_${invoice.to.name.replace(/\s+/g, '_') || 'invoice'}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, 
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
        // Enable auto-paging with CSS break avoidance
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } 
      };

      await html2pdf().set(opt).from(clone).save();
      
      // Cleanup
      document.body.removeChild(container);
      setIsDownloading(false);

    } catch (err) {
      console.error("PDF Error:", err);
      setIsDownloading(false);
      if (confirm("Automatic PDF generation failed. Use standard Print dialog?")) {
        handlePrint();
      }
    }
  };

  const handleLogoUpload = (e) => {
    const file = e.target.files[0];
    const nameInput = document.getElementById('newLogoName');
    const name = nameInput?.value || file.name;

    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        const newLogo = { id: generateId(), name: name, data: reader.result };
        setLogoProfiles([...logoProfiles, newLogo]);
        if (!preferences.selectedLogoId) setPreference('selectedLogoId', newLogo.id);
        if (nameInput) nameInput.value = '';
      };
      reader.readAsDataURL(file);
    }
  };

  const handleMaterialImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setTempMaterialImage(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  // --- REVISED SAVE FUNCTION ---
  const handleSaveInvoice = (asNew = false) => {
    const name = saveName.trim() || invoice.name || `Invoice ${invoice.number}`;
    
    // If saving as new, generate a new ID immediately
    const idToUse = asNew ? generateId() : invoice.id;
    
    const invoiceToSave = {
      ...invoice,
      id: idToUse,
      name,
      savedAt: new Date().toISOString(),
      config: { ...preferences } 
    };

    if (asNew) {
        // Just add it to the list
        setSavedInvoices([...savedInvoices, invoiceToSave]);
        // Update current view to look at this new ID so future 'regular' saves update this one
        setInvoice(invoiceToSave); 
    } else {
        // Update existing logic
        const existingIndex = savedInvoices.findIndex(inv => inv.id === invoice.id);
        if (existingIndex >= 0) {
            const newSavedInvoices = [...savedInvoices];
            newSavedInvoices[existingIndex] = invoiceToSave;
            setSavedInvoices(newSavedInvoices);
        } else {
            setSavedInvoices([...savedInvoices, invoiceToSave]);
        }
        // Update name in current view if changed
        setInvoice(prev => ({ ...prev, name })); 
    }

    setShowSaveModal(false);
    setSaveName('');
  };

  const handleLoadInvoice = (savedInv) => {
    setInvoice({ ...savedInv });
    if (savedInv.config) {
      setPreferences(savedInv.config);
    }
    setShowLoadModal(false);
  };

  const handleDeleteSavedInvoice = (id) => {
    setSavedInvoices(savedInvoices.filter(inv => inv.id !== id));
  };

  const togglePaymentStatus = () => {
    setInvoice(prev => ({ ...prev, isPaid: !prev.isPaid }));
  };

  // --- Backup & Restore Logic ---

  const handleBackupData = () => {
    const backup = {
      version: 1,
      date: new Date().toISOString(),
      data: {
        markupProfiles,
        depositProfiles,
        savedMaterials,
        logoProfiles,
        savedInvoices,
        preferences,
        currentDraft: invoice
      }
    };
    
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ProInvoice_Backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const handleRestoreData = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const backup = JSON.parse(event.target.result);
        if (backup && backup.data) {
          if (confirm('This will overwrite all current data with the backup. Are you sure?')) {
            const { data } = backup;
            if(data.markupProfiles) setMarkupProfiles(data.markupProfiles);
            if(data.depositProfiles) setDepositProfiles(data.depositProfiles);
            if(data.savedMaterials) setSavedMaterials(data.savedMaterials);
            if(data.logoProfiles) setLogoProfiles(data.logoProfiles);
            if(data.savedInvoices) setSavedInvoices(data.savedInvoices);
            if(data.preferences) setPreferences(data.preferences);
            if(data.currentDraft) setInvoice(data.currentDraft);
            alert('Restore successful!');
            setShowConfigModal(false);
          }
        } else {
          alert('Invalid backup file format.');
        }
      } catch (err) {
        alert('Error parsing backup file.');
        console.error(err);
      }
    };
    reader.readAsText(file);
    e.target.value = null; // Reset input
  };

  // --- Render ---

  return (
    <div className={`min-h-screen bg-slate-50 font-sans text-slate-800 ${isPrintMode ? 'p-0 bg-white' : 'p-4 md:p-8'}`}>
      
      {/* Top Bar */}
      {!isPrintMode && (
        <header className="w-full mx-auto mb-6 md:mb-10 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 md:gap-6">
          <div className="flex items-center gap-3">
            <div>
              <h1 className="text-xl md:text-2xl font-bold tracking-tight text-slate-900">Error 101's Invoice Generator</h1>
              <p className="text-slate-500 text-xs md:text-sm">Professional Generator</p>
            </div>
          </div>
          
          <div className="flex flex-wrap gap-2 w-full lg:w-auto">
            <div className="flex gap-2 mr-2 border-r border-slate-200 pr-2">
               <Button variant="secondary" icon={FilePlus} onClick={handleNewInvoice} title="Create New Invoice">
                New
               </Button>
               <Button variant="secondary" icon={FolderOpen} onClick={() => setShowLoadModal(true)}>
                Load
              </Button>
               <Button variant="secondary" icon={Save} onClick={() => { setSaveName(invoice.name); setShowSaveModal(true); }}>
                Save
              </Button>
            </div>
            <Button variant="outline" icon={Settings} onClick={() => setShowConfigModal(true)}>
              Settings
            </Button>
            <Button variant="secondary" icon={Package} onClick={() => setShowMaterialModal(true)}>
              Materials
            </Button>
            <Button variant="outline" icon={Download} onClick={handleDownloadPDF} disabled={isDownloading} title="Download PDF File">
              {isDownloading ? 'Generating...' : 'Download PDF'}
            </Button>
            <Button variant="primary" icon={Printer} onClick={handlePrint}>
              Print
            </Button>
          </div>
        </header>
      )}

      <div className={`w-full mx-auto grid grid-cols-1 ${isPrintMode ? 'lg:grid-cols-1' : 'lg:grid-cols-12'} gap-6 md:gap-8`}>
        
        {/* LEFT COLUMN: Controls */}
        {!isPrintMode && (
          <div className="lg:col-span-4 space-y-6">
            
            {/* Branding Card */}
            <Card className="p-5 space-y-4">
               <h2 className="font-semibold text-slate-700 flex items-center gap-2">
                <ImageIcon size={18} /> Branding
              </h2>
              <div>
                <label className="text-xs font-semibold uppercase text-slate-400 mb-1 block">Selected Logo</label>
                <div className="relative">
                  <select 
                    value={preferences.selectedLogoId} 
                    onChange={e => setPreference('selectedLogoId', e.target.value)}
                    className="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm appearance-none outline-none"
                  >
                    <option value="">No Logo</option>
                    {logoProfiles.map(p => (
                      <option key={p.id} value={p.id}>{p.name}</option>
                    ))}
                  </select>
                  <ChevronDown className="absolute right-3 top-2.5 text-slate-400 pointer-events-none" size={16} />
                </div>
                {activeLogo && (
                  <div className="mt-3 p-2 border border-slate-100 bg-slate-50 rounded flex justify-center">
                    <img src={activeLogo.data} alt="Preview" className="h-12 object-contain" />
                  </div>
                )}
                 {logoProfiles.length === 0 && (
                   <p className="text-xs text-slate-400 mt-2 italic">Add logos in Settings</p>
                 )}
              </div>
            </Card>

            {/* Invoice Meta */}
            <Card className="p-5 space-y-4">
              <h2 className="font-semibold text-slate-700 flex items-center gap-2">
                <Briefcase size={18} /> Invoice Details
              </h2>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-xs font-semibold uppercase text-slate-400 mb-1 block">Number</label>
                  <input 
                    type="text" 
                    value={invoice.number} 
                    onChange={e => setInvoice({...invoice, number: e.target.value})}
                    className="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                  />
                </div>
                <div>
                  <label className="text-xs font-semibold uppercase text-slate-400 mb-1 block">Date</label>
                  <input 
                    type="date" 
                    value={invoice.date} 
                    onChange={e => setInvoice({...invoice, date: e.target.value})}
                    className="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm outline-none"
                  />
                </div>
              </div>
              <div>
                  <label className="text-xs font-semibold uppercase text-slate-400 mb-1 block">Due Date</label>
                  <input 
                    type="date" 
                    value={invoice.dueDate} 
                    onChange={e => setInvoice({...invoice, dueDate: e.target.value})}
                    className="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm outline-none"
                  />
              </div>
              
              <div className="pt-2 border-t border-slate-100">
                <label className="text-xs font-semibold uppercase text-slate-400 mb-2 block">Payment Status</label>
                <div className="flex bg-slate-100 p-1 rounded-lg">
                  <button 
                    onClick={() => setInvoice({...invoice, isPaid: false})}
                    className={`flex-1 flex items-center justify-center gap-2 py-2 px-3 rounded-md text-sm font-medium transition-all ${!invoice.isPaid ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                  >
                    <Circle size={16} /> Unpaid
                  </button>
                  <button 
                    onClick={() => setInvoice({...invoice, isPaid: true})}
                    className={`flex-1 flex items-center justify-center gap-2 py-2 px-3 rounded-md text-sm font-medium transition-all ${invoice.isPaid ? 'bg-white text-green-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                  >
                    <CheckCircle size={16} /> Paid
                  </button>
                </div>
              </div>
            </Card>

            {/* Financial Config */}
            <Card className="p-5 space-y-4">
              <h2 className="font-semibold text-slate-700 flex items-center gap-2">
                <CreditCard size={18} /> Financials
              </h2>
              
              <div>
                <label className="text-xs font-semibold uppercase text-slate-400 mb-1 block">Markup Profile</label>
                <div className="relative">
                  <select 
                    value={preferences.selectedMarkupId} 
                    onChange={e => setPreference('selectedMarkupId', e.target.value)}
                    className="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm appearance-none outline-none"
                  >
                    {markupProfiles.map(p => (
                      <option key={p.id} value={p.id}>
                        {p.name} ({p.type === 'percent' ? `${p.value}%` : `$${p.value}`})
                      </option>
                    ))}
                    <option value="">None</option>
                  </select>
                  <ChevronDown className="absolute right-3 top-2.5 text-slate-400 pointer-events-none" size={16} />
                </div>
              </div>

              <div>
                <div className="flex justify-between items-center mb-1">
                  <label className="text-xs font-semibold uppercase text-slate-400 block">Markup Visibility</label>
                </div>
                <button 
                  onClick={() => setInvoice(prev => ({ ...prev, hideMarkup: !prev.hideMarkup }))}
                  className={`w-full flex items-center justify-between p-2 rounded text-sm border ${invoice.hideMarkup ? 'bg-slate-100 border-slate-300 text-slate-600' : 'bg-white border-slate-200 text-slate-800'}`}
                >
                  <span className="flex items-center gap-2">
                    {invoice.hideMarkup ? <EyeOff size={16} /> : <Eye size={16} />}
                    {invoice.hideMarkup ? 'Markup Hidden on Invoice' : 'Markup Visible on Invoice'}
                  </span>
                  <span className={`text-xs px-2 py-0.5 rounded-full ${invoice.hideMarkup ? 'bg-slate-200' : 'bg-green-100 text-green-700'}`}>
                    {invoice.hideMarkup ? 'Merged' : 'Separate'}
                  </span>
                </button>
              </div>

              <div>
                <label className="text-xs font-semibold uppercase text-slate-400 mb-1 block">Deposit / Retainer</label>
                <div className="relative">
                  <select 
                    value={preferences.selectedDepositId} 
                    onChange={e => setPreference('selectedDepositId', e.target.value)}
                    className="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm appearance-none outline-none"
                  >
                    {depositProfiles.map(p => (
                      <option key={p.id} value={p.id}>
                        {p.name} ({p.type === 'percent' ? `${p.value}%` : `$${p.value}`})
                      </option>
                    ))}
                    <option value="">None</option>
                  </select>
                  <ChevronDown className="absolute right-3 top-2.5 text-slate-400 pointer-events-none" size={16} />
                </div>
              </div>

              <div>
                <label className="text-xs font-semibold uppercase text-slate-400 mb-1 block">Tax Rate (%)</label>
                <div className="relative">
                  <input 
                    type="number" 
                    value={preferences.taxRate} 
                    onChange={e => setPreference('taxRate', Number(e.target.value))}
                    className="w-full p-2 bg-slate-50 border border-slate-200 rounded text-sm outline-none pl-8"
                  />
                  <Percent className="absolute left-2.5 top-2.5 text-slate-400 pointer-events-none" size={14} />
                </div>
              </div>
            </Card>

            <Card className="p-5 space-y-4">
               <h2 className="font-semibold text-slate-700 flex items-center gap-2">
                <Package size={18} /> Quick Add Material
              </h2>
              <div className="grid grid-cols-1 gap-2">
                {savedMaterials.slice(0, 3).map(mat => (
                  <button 
                    key={mat.id}
                    onClick={() => handleAddItem(mat)}
                    className="text-left text-sm p-2 hover:bg-blue-50 text-slate-600 rounded flex justify-between group transition-colors"
                  >
                    <span className="truncate pr-2">{mat.name}</span>
                    <span className="font-medium text-slate-900 group-hover:text-blue-600 shrink-0">${mat.price}</span>
                  </button>
                ))}
                <button 
                  onClick={() => setShowMaterialModal(true)}
                  className="text-xs text-blue-600 font-medium hover:underline mt-2 text-center"
                >
                  View All / Add New Material
                </button>
              </div>
            </Card>
            
            {/* NEW FOOTER */}
            <div className="text-center text-xs text-slate-400 py-4">
              <p className="font-medium">By Error101 Â© 2025</p>
              <p>Licensed under CC BY-NC 4.0</p>
            </div>
          </div>
        )}

        {/* RIGHT COLUMN: The Invoice (WYSIWYG) */}
        <div className={`${isPrintMode ? 'w-full' : 'lg:col-span-8'}`}>
          <div id="invoice-content" className="bg-white shadow-xl shadow-slate-200/60 rounded-xl min-h-[auto] md:min-h-[1000px] flex flex-col print:shadow-none print:rounded-none relative overflow-hidden">
            
            {/* PAID Stamp */}
            {invoice.isPaid && (
              <div className="absolute top-1/3 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none z-10 opacity-20 border-4 md:border-8 border-green-600 text-green-600 rounded-xl p-4 md:p-8 transform -rotate-12 animate-in fade-in zoom-in duration-500">
                <div className="text-6xl md:text-[8rem] font-black tracking-widest leading-none">PAID</div>
                <div className="text-lg md:text-2xl font-bold text-center uppercase tracking-[1em] mt-2">In Full</div>
              </div>
            )}

            {/* Header Section */}
            <div className="p-6 md:p-12 border-b border-slate-100 flex flex-col md:flex-row justify-between items-start gap-6 md:gap-0">
              <div className="flex-1 w-full md:w-auto">
                
                {/* Logo Display */}
                {activeLogo ? (
                   <div className="mb-6">
                     <img src={activeLogo.data} alt="Company Logo" className="h-16 md:h-20 object-contain" />
                   </div>
                ) : (
                   <div className="h-4"></div>
                )}

                {!isPrintMode ? (
                  <textarea
                    value={invoice.from.name}
                    onChange={e => setInvoice(prev => ({...prev, from: {...prev.from, name: e.target.value}}))}
                    className="text-3xl font-bold text-slate-900 bg-transparent border-none placeholder-slate-300 focus:ring-0 p-0 w-full resize-none"
                    placeholder="Your Company Name"
                    rows={1}
                  />
                ) : (
                  <h1 className="text-3xl font-bold text-slate-900">{invoice.from.name}</h1>
                )}
                
                {!isPrintMode ? (
                  <textarea
                    value={invoice.from.address}
                    onChange={e => setInvoice(prev => ({...prev, from: {...prev.from, address: e.target.value}}))}
                    className="mt-2 text-slate-500 bg-transparent border-none focus:ring-0 p-0 w-full resize-none text-sm"
                    placeholder="Your Address..."
                    rows={3}
                  />
                ) : (
                  <pre className="mt-2 text-slate-500 text-sm font-sans whitespace-pre-wrap">{invoice.from.address}</pre>
                )}
              </div>

              <div className="text-left md:text-right w-full md:w-auto">
                <h2 className="text-5xl font-light text-slate-200 uppercase tracking-widest">Invoice</h2>
                <div className="mt-4 space-y-1">
                  <div className="flex justify-between gap-8 text-sm">
                    <span className="text-slate-400">Invoice #</span>
                    <span className="font-medium text-slate-700">{invoice.number}</span>
                  </div>
                  <div className="flex justify-between gap-8 text-sm">
                    <span className="text-slate-400">Date</span>
                    <span className="font-medium text-slate-700">{invoice.date}</span>
                  </div>
                  <div className="flex justify-between gap-8 text-sm">
                    <span className="text-slate-400">Due Date</span>
                    <span className="font-medium text-slate-700">{invoice.dueDate}</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Bill To */}
            <div className="p-6 md:p-12 pb-0">
              <h3 className="text-xs font-bold uppercase text-slate-400 mb-2">Bill To</h3>
               {!isPrintMode ? (
                  <div className="space-y-2">
                    <input
                      value={invoice.to.name}
                      onChange={e => setInvoice(prev => ({...prev, to: {...prev.to, name: e.target.value}}))}
                      className="text-xl font-semibold text-slate-800 bg-slate-50 border border-slate-200 rounded px-2 py-1 focus:ring-1 focus:ring-blue-500 w-full max-w-md"
                      placeholder="Client Name"
                    />
                    <textarea
                      value={invoice.to.address}
                      onChange={e => setInvoice(prev => ({...prev, to: {...prev.to, address: e.target.value}}))}
                      className="text-slate-600 bg-slate-50 border border-slate-200 rounded px-2 py-1 focus:ring-1 focus:ring-blue-500 w-full max-w-md resize-none text-sm"
                      placeholder="Client Address..."
                      rows={3}
                    />
                  </div>
                ) : (
                  <div>
                    <h3 className="text-xl font-semibold text-slate-800">{invoice.to.name}</h3>
                    <pre className="text-slate-600 font-sans text-sm whitespace-pre-wrap mt-1">{invoice.to.address}</pre>
                  </div>
                )}
            </div>

            {/* Items Table */}
            <div className="p-6 md:p-12 flex-grow overflow-x-auto">
              <table className="w-full table-fixed min-w-[600px] md:min-w-0">
                <thead>
                  <tr className="border-b-2 border-slate-100 text-left">
                    <th className="py-3 text-xs font-bold uppercase text-slate-400 w-[50%]">Description</th>
                    <th className="py-3 text-xs font-bold uppercase text-slate-400 text-right w-[10%]">Qty</th>
                    <th className="py-3 text-xs font-bold uppercase text-slate-400 text-right w-[15%]">Price</th>
                    <th className="py-3 text-xs font-bold uppercase text-slate-400 text-right w-[15%]">Total</th>
                    {!isPrintMode && <th className="w-[10%]"></th>}
                  </tr>
                </thead>
                <tbody className="text-sm">
                  {invoice.items.map((item) => {
                    const description = item.description || '';
                    return (
                    <tr key={item.id} className="border-b border-slate-50 group hover:bg-slate-50/50 break-inside-avoid page-break-inside-avoid">
                      <td className="py-4 pr-4 align-top">
                        <div className="flex gap-4">
                          {/* Item Image Display */}
                          {item.image && (
                            <div className="w-16 h-16 shrink-0 bg-slate-100 rounded border border-slate-200 overflow-hidden flex items-center justify-center">
                              <img src={item.image} alt="item" className="w-full h-full object-cover" />
                            </div>
                          )}

                          <div className="flex-1">
                            {!isPrintMode ? (
                              <div className="relative">
                                <textarea
                                  value={description}
                                  onChange={(e) => handleUpdateItem(item.id, 'description', e.target.value)}
                                  className="w-full bg-transparent border-none resize-none p-0 focus:ring-0 min-h-[1.5rem]"
                                  placeholder="Item description"
                                  rows={Math.max(1, Math.ceil(description.length / 50))}
                                />
                                <div className="mt-1 flex gap-2">
                                  <label className="text-xs text-blue-500 hover:text-blue-700 cursor-pointer flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <ImageIcon size={12} /> {item.image ? 'Change Image' : 'Add Image'}
                                    <input 
                                      type="file" 
                                      className="hidden" 
                                      accept="image/*"
                                      onChange={(e) => handleItemImageUpload(e, item.id)}
                                    />
                                  </label>
                                  {item.image && (
                                    <button 
                                      onClick={() => handleUpdateItem(item.id, 'image', null)}
                                      className="text-xs text-red-400 hover:text-red-600 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                    >
                                      Remove
                                    </button>
                                  )}
                                </div>
                              </div>
                            ) : (
                              <span className="font-medium text-slate-700 whitespace-pre-wrap">{description}</span>
                            )}
                          </div>
                        </div>
                      </td>
                      <td className="py-4 text-right align-top">
                        {!isPrintMode ? (
                          <input
                            type="number"
                            value={item.quantity}
                            onChange={(e) => handleUpdateItem(item.id, 'quantity', Number(e.target.value))}
                            className="w-full text-right bg-transparent border border-slate-200 rounded p-1"
                          />
                        ) : (
                           item.quantity 
                        )}
                      </td>
                      <td className="py-4 text-right align-top">
                        {!isPrintMode ? (
                          <div className="flex justify-end items-center">
                            <span className="text-slate-400 mr-1">$</span>
                            <input
                              type="number"
                              value={item.price}
                              onChange={(e) => handleUpdateItem(item.id, 'price', Number(e.target.value))}
                              className="w-20 text-right bg-transparent border border-slate-200 rounded p-1"
                            />
                          </div>
                        ) : (
                          CURRENCY_FORMAT.format(item.price)
                        )}
                      </td>
                      <td className="py-4 text-right font-medium text-slate-700 align-top">
                        {CURRENCY_FORMAT.format(item.quantity * item.price)}
                      </td>
                      {!isPrintMode && (
                        <td className="py-4 text-right align-top">
                          <button 
                            onClick={() => handleRemoveItem(item.id)}
                            className="text-slate-300 hover:text-red-500 transition-colors p-2"
                          >
                            <Trash2 size={16} />
                          </button>
                        </td>
                      )}
                    </tr>
                  )})}
                </tbody>
              </table>

              {!isPrintMode && (
                <div className="mt-4 flex gap-3 items-center">
                  <Button onClick={() => handleAddItem()} variant="secondary" icon={Plus} className="text-sm">
                    Add Empty Line
                  </Button>
                  
                  {savedMaterials.length > 0 && (
                    <div className="relative">
                      <select 
                        className="appearance-none bg-slate-100 border-none text-slate-700 text-sm rounded-lg pl-3 pr-8 py-2 font-medium hover:bg-slate-200 cursor-pointer focus:ring-2 focus:ring-blue-500 outline-none transition-colors"
                        onChange={(e) => {
                          const mat = savedMaterials.find(m => m.id === e.target.value);
                          if (mat) handleAddItem(mat);
                          e.target.value = ""; // Reset dropdown
                        }}
                        defaultValue=""
                      >
                        <option value="" disabled>Add from Saved Materials...</option>
                        {savedMaterials.map(m => (
                          <option key={m.id} value={m.id}>{m.name} - ${m.price}</option>
                        ))}
                      </select>
                      <ChevronDown size={14} className="absolute right-3 top-3 text-slate-500 pointer-events-none" />
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Totals Section */}
            <div className="bg-slate-50 p-6 md:p-12 border-t border-slate-100 print:bg-transparent break-inside-avoid">
              <div className="flex flex-col md:flex-row justify-between items-end gap-12">
                <div className="w-full md:w-1/2">
                  <h3 className="text-xs font-bold uppercase text-slate-400 mb-2">Notes</h3>
                  {!isPrintMode ? (
                    <textarea 
                      value={invoice.notes}
                      onChange={e => setInvoice({...invoice, notes: e.target.value})}
                      className="w-full bg-white border border-slate-200 rounded p-3 text-sm text-slate-600 focus:ring-1 focus:ring-blue-500 h-32 resize-none"
                    />
                  ) : (
                    <p className="text-sm text-slate-600 whitespace-pre-wrap">{invoice.notes}</p>
                  )}
                </div>

                <div className="w-full md:w-1/3 space-y-3">
                  <div className="flex justify-between text-slate-600">
                    <span>{invoice.hideMarkup ? 'Subtotal' : 'Subtotal'}</span>
                    <span>{CURRENCY_FORMAT.format(invoice.hideMarkup ? totals.subtotalWithMarkup : totals.subtotal)}</span>
                  </div>

                  {totals.markupAmount > 0 && !invoice.hideMarkup && (
                     <div className="flex justify-between text-green-600">
                      <span>Markup ({totals.markupName})</span>
                      <span>+ {CURRENCY_FORMAT.format(totals.markupAmount)}</span>
                    </div>
                  )}

                  <div className="flex justify-between text-slate-600">
                    <span>Tax ({preferences.taxRate}%)</span>
                    <span>{CURRENCY_FORMAT.format(totals.taxAmount)}</span>
                  </div>

                  <div className="border-t border-slate-200 pt-3 flex justify-between font-bold text-slate-800 text-lg">
                    <span>Total</span>
                    <span>{CURRENCY_FORMAT.format(totals.total)}</span>
                  </div>

                   {totals.depositAmount > 0 && !invoice.isPaid && (
                     <div className="flex justify-between text-blue-600 font-medium">
                      <span>Deposit ({totals.depositName})</span>
                      <span>- {CURRENCY_FORMAT.format(totals.depositAmount)}</span>
                    </div>
                  )}
                  
                  {invoice.isPaid && (
                     <div className="flex justify-between text-green-600 font-medium">
                      <span>Amount Paid</span>
                      <span>- {CURRENCY_FORMAT.format(totals.total)}</span>
                    </div>
                  )}

                  <div className="border-t-2 border-slate-800 pt-3 flex justify-between font-bold text-slate-900 text-xl">
                    <span>Balance Due</span>
                    <span>{CURRENCY_FORMAT.format(totals.balanceDue)}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* --- Modals --- */}

      {/* Save Invoice Modal */}
      <Modal isOpen={showSaveModal} onClose={() => setShowSaveModal(false)} title="Save Invoice / Template">
        <div className="space-y-4">
          <p className="text-sm text-slate-600">Give your invoice a name to save it as a template or draft. It will be stored in your browser.</p>
          <div>
            <label className="text-xs font-bold uppercase text-slate-400 mb-1 block">Invoice Name</label>
            <input 
              value={saveName} 
              onChange={e => setSaveName(e.target.value)} 
              placeholder="e.g. Website Project Template"
              className="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
              autoFocus
            />
          </div>
          <div className="flex justify-end gap-2 pt-2">
            <Button onClick={() => handleSaveInvoice(true)} variant="outline" icon={Copy}>Save as New</Button>
            <Button onClick={() => handleSaveInvoice(false)} icon={Save}>Save Changes</Button>
          </div>
        </div>
      </Modal>

      {/* Load Invoice Modal */}
      <Modal isOpen={showLoadModal} onClose={() => setShowLoadModal(false)} title="Saved Invoices">
        <div className="space-y-4">
          {savedInvoices.length === 0 ? (
            <div className="text-center py-8 text-slate-400">
              <FolderOpen size={48} className="mx-auto mb-2 opacity-50"/>
              <p>No saved invoices found.</p>
            </div>
          ) : (
            <div className="space-y-2 max-h-96 overflow-y-auto">
              {savedInvoices.map(inv => (
                <div key={inv.id} className="bg-slate-50 border border-slate-200 p-4 rounded-lg flex justify-between items-center group hover:bg-white hover:shadow-sm transition-all">
                  <div>
                    <h4 className="font-bold text-slate-800">{inv.name}</h4>
                    <div className="text-xs text-slate-500 mt-1 flex gap-3">
                      <span>#{inv.number}</span>
                      <span>To: {inv.to.name}</span>
                      <span>Amount: {CURRENCY_FORMAT.format(inv.items.reduce((acc, i) => acc + (i.quantity * i.price), 0))}</span>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <Button variant="outline" className="text-xs py-1 px-3" onClick={() => handleLoadInvoice(inv)}>Load</Button>
                    <button onClick={() => handleDeleteSavedInvoice(inv.id)} className="text-slate-400 hover:text-red-500 p-2">
                      <Trash2 size={16} />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </Modal>

      {/* Materials Modal */}
      <Modal isOpen={showMaterialModal} onClose={() => { setShowMaterialModal(false); setTempMaterialImage(null); }} title="Manage Saved Materials">
        <div className="space-y-6">
          
          {/* Add New Section */}
          <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
            <h4 className="text-sm font-bold text-slate-700 mb-3">Add New Material</h4>
            <div className="space-y-3">
              <div className="flex gap-2">
                <input 
                  id="newMatName" 
                  placeholder="Item Name / Description" 
                  className="flex-1 border p-2 rounded text-sm"
                />
                <input 
                  id="newMatPrice" 
                  type="number" 
                  placeholder="Price" 
                  className="w-24 border p-2 rounded text-sm"
                />
              </div>
              
              <div className="flex items-center gap-3">
                <label className="cursor-pointer bg-white border border-slate-300 rounded px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 transition-colors flex items-center gap-2">
                   <ImageIcon size={16} />
                   <span>{tempMaterialImage ? 'Change Image' : 'Add Image'}</span>
                   <input type="file" accept="image/*" className="hidden" onChange={handleMaterialImageUpload}/>
                </label>
                
                {tempMaterialImage && (
                  <div className="relative group">
                    <img src={tempMaterialImage} alt="preview" className="h-10 w-10 object-cover rounded border border-slate-200" />
                    <button 
                      onClick={() => setTempMaterialImage(null)}
                      className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity"
                    >
                      <X size={10} />
                    </button>
                  </div>
                )}

                <div className="flex-1 text-right">
                  <Button 
                    onClick={() => {
                      const name = document.getElementById('newMatName').value;
                      const price = Number(document.getElementById('newMatPrice').value);
                      if(name) {
                        setSavedMaterials([...savedMaterials, { 
                          id: generateId(), 
                          name, 
                          price,
                          image: tempMaterialImage
                        }]);
                        document.getElementById('newMatName').value = '';
                        document.getElementById('newMatPrice').value = '';
                        setTempMaterialImage(null);
                      }
                    }} 
                    icon={Plus}
                  >
                    Add Item
                  </Button>
                </div>
              </div>
            </div>
          </div>

          {/* List Section */}
          <div className="border rounded-lg overflow-hidden">
            <table className="w-full text-sm text-left">
              <thead className="bg-slate-50 border-b">
                <tr>
                  <th className="p-3 w-16">Img</th>
                  <th className="p-3">Name</th>
                  <th className="p-3 text-right">Price</th>
                  <th className="p-3 w-32 text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                {savedMaterials.map(mat => (
                  <tr key={mat.id} className="border-b last:border-0 hover:bg-slate-50">
                    <td className="p-3">
                      {mat.image ? (
                        <img src={mat.image} alt="thumb" className="w-10 h-10 object-cover rounded border border-slate-200" />
                      ) : (
                        <div className="w-10 h-10 bg-slate-100 rounded border border-slate-200 flex items-center justify-center text-slate-300">
                          <ImageIcon size={16} />
                        </div>
                      )}
                    </td>
                    <td className="p-3 align-middle font-medium">{mat.name}</td>
                    <td className="p-3 align-middle text-right">${mat.price}</td>
                    <td className="p-3 align-middle text-right">
                      <div className="flex justify-end gap-1">
                        <button 
                          onClick={() => { handleAddItem(mat); setShowMaterialModal(false); }}
                          className="p-2 text-blue-600 hover:bg-blue-50 rounded"
                          title="Add to Current Invoice"
                        >
                          <ArrowRight size={16} />
                        </button>
                        <button 
                          onClick={() => setSavedMaterials(savedMaterials.filter(m => m.id !== mat.id))} 
                          className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded"
                          title="Delete Material"
                        >
                          <Trash2 size={16} />
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
                {savedMaterials.length === 0 && (
                  <tr><td colSpan={4} className="p-8 text-center text-slate-400">No saved materials yet.</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </Modal>

      {/* Configuration Modal (Markups / Deposits / Logos) */}
      <Modal isOpen={showConfigModal} onClose={() => setShowConfigModal(false)} title="Invoice Configuration">
        <div className="space-y-8">
          
           {/* Backup Section */}
           <div>
            <h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
              <RefreshCw size={16}/> Backup & Restore Data
            </h4>
            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-3">
              <p className="text-sm text-slate-600">Download all your invoice data, templates, and settings to a file, or restore from a backup.</p>
              <div className="flex gap-3">
                <Button onClick={handleBackupData} variant="secondary" icon={Download} className="text-sm">
                  Export Data
                </Button>
                <div className="relative">
                  <Button onClick={() => fileInputRef.current?.click()} variant="outline" icon={UploadIcon} className="text-sm">
                    Import Backup
                  </Button>
                  <input 
                    type="file" 
                    ref={fileInputRef}
                    className="hidden" 
                    accept="application/json" 
                    onChange={handleRestoreData}
                  />
                </div>
              </div>
            </div>
           </div>

           <hr className="border-slate-100" />
          
           {/* Logo Section */}
           <div>
            <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2">
              <ImageIcon size={16}/> Logo Profiles
            </h4>
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4">
               <div className="flex flex-col gap-2">
                 <input 
                   id="newLogoName" 
                   placeholder="Profile Name (e.g., Dark Logo)" 
                   className="border p-2 rounded text-sm w-full"
                 />
                 <div className="flex gap-2">
                   <label className="flex-1 cursor-pointer bg-white border border-slate-300 border-dashed rounded flex items-center justify-center p-2 text-sm text-slate-500 hover:bg-slate-50 transition-colors">
                     <Upload size={16} className="mr-2"/>
                     <span>Upload Image...</span>
                     <input type="file" accept="image/*" className="hidden" onChange={handleLogoUpload}/>
                   </label>
                 </div>
               </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
              {logoProfiles.map(p => (
                <div key={p.id} className="flex items-center gap-3 p-3 bg-slate-50 rounded border border-slate-100">
                  <div className="w-10 h-10 bg-white rounded flex items-center justify-center border border-slate-200 flex-shrink-0">
                     <img src={p.data} alt={p.name} className="max-w-full max-h-full p-1" />
                  </div>
                  <div className="flex-1 overflow-hidden">
                     <span className="text-sm font-medium truncate block">{p.name}</span>
                  </div>
                  <button onClick={() => setLogoProfiles(logoProfiles.filter(l => l.id !== p.id))} className="text-slate-400 hover:text-red-500 p-1">
                    <Trash2 size={14} />
                  </button>
                </div>
              ))}
               {logoProfiles.length === 0 && (
                  <div className="col-span-2 text-center text-slate-400 text-sm py-2">No logos saved yet.</div>
               )}
            </div>
          </div>

          <hr className="border-slate-100" />

          {/* Markup Section */}
          <div>
            <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2">
              <LayoutTemplate size={16}/> Markup Profiles
            </h4>
            <div className="flex gap-2 mb-3">
               <input id="newMarkupName" placeholder="Profile Name (e.g. Rush)" className="flex-1 border p-2 rounded text-sm"/>
               <select id="newMarkupType" className="border p-2 rounded text-sm bg-white">
                 <option value="percent">%</option>
                 <option value="fixed">$</option>
               </select>
               <input id="newMarkupVal" type="number" placeholder="20" className="w-20 border p-2 rounded text-sm"/>
               <Button onClick={() => {
                 const name = document.getElementById('newMarkupName').value;
                 const type = document.getElementById('newMarkupType').value;
                 const value = Number(document.getElementById('newMarkupVal').value);
                 if(name) {
                   setMarkupProfiles([...markupProfiles, { id: generateId(), name, type, value }]);
                   document.getElementById('newMarkupName').value = '';
                   document.getElementById('newMarkupVal').value = '';
                 }
               }} icon={Plus}>Add</Button>
            </div>
            <div className="space-y-2">
              {markupProfiles.map(p => (
                <div key={p.id} className="flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-100">
                  <span className="text-sm font-medium">{p.name}</span>
                  <div className="flex items-center gap-3">
                    <span className="text-xs bg-white px-2 py-1 rounded border shadow-sm">
                      {p.type === 'percent' ? `${p.value}%` : `$${p.value}`}
                    </span>
                    <button onClick={() => setMarkupProfiles(markupProfiles.filter(m => m.id !== p.id))} className="text-slate-400 hover:text-red-500">
                      <Trash2 size={14} />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <hr className="border-slate-100" />

          {/* Deposit Section */}
          <div>
            <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2">
              <CreditCard size={16}/> Deposit Profiles
            </h4>
            <div className="flex gap-2 mb-3">
               <input id="newDepName" placeholder="Profile Name" className="flex-1 border p-2 rounded text-sm"/>
               <select id="newDepType" className="border p-2 rounded text-sm bg-white">
                 <option value="percent">%</option>
                 <option value="fixed">$</option>
               </select>
               <input id="newDepVal" type="number" placeholder="50" className="w-20 border p-2 rounded text-sm"/>
               <Button onClick={() => {
                 const name = document.getElementById('newDepName').value;
                 const type = document.getElementById('newDepType').value;
                 const value = Number(document.getElementById('newDepVal').value);
                 if(name) {
                   setDepositProfiles([...depositProfiles, { id: generateId(), name, type, value }]);
                   document.getElementById('newDepName').value = '';
                   document.getElementById('newDepVal').value = '';
                 }
               }} icon={Plus}>Add</Button>
            </div>
             <div className="space-y-2">
              {depositProfiles.map(p => (
                <div key={p.id} className="flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-100">
                  <span className="text-sm font-medium">{p.name}</span>
                   <div className="flex items-center gap-3">
                    <span className="text-xs bg-white px-2 py-1 rounded border shadow-sm">
                      {p.type === 'percent' ? `${p.value}%` : `$${p.value}`}
                    </span>
                    <button onClick={() => setDepositProfiles(depositProfiles.filter(m => m.id !== p.id))} className="text-slate-400 hover:text-red-500">
                      <Trash2 size={14} />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>

        </div>
      </Modal>

      {/* Print Styles */}
      <style>{`
        @media print {
          @page { margin: 0; size: auto; }
          body { background: white; }
          .no-print { display: none !important; }
        }
        tr, .break-inside-avoid {
          page-break-inside: avoid;
        }
      `}</style>
    </div>
  );
}
